import{r as a,j as e,a as L}from"./index-_ibJpO5e.js";import{A as C}from"./AdminLayout-DEpWlMYQ.js";const A="https://backend-three-sigma-81.vercel.app/api";function T(){const x=localStorage.getItem("gm_auth");if(x)try{const n=JSON.parse(x);if(n&&n.token)return{Authorization:`Bearer ${n.token}`}}catch{}const r=localStorage.getItem("admin_dashboard_token");return r?{Authorization:`Bearer ${r}`}:{}}function D(){const[x,r]=a.useState(!1),[n,h]=a.useState([]),[f,m]=a.useState([]),[j,d]=a.useState(null),[u,v]=a.useState(localStorage.getItem("admin_dashboard_token")||""),[g,o]=a.useState(""),[l,S]=a.useState(""),[b,_]=a.useState(!1),p=async()=>{var s,t;r(!0),d(null);try{const i=T(),c=await fetch(`${A}/admin/debug/sessions`,{headers:i});if(!c.ok){if(c.status===401||c.status===403){d('Unauthorized (401/403). Paste an admin JWT below and click "Set token".'),h([]),m([]),r(!1);return}throw new Error("Failed")}const w=await c.json();h(((s=w.data)==null?void 0:s.sessions)||[]),m(((t=w.data)==null?void 0:t.views)||[])}catch(i){console.error("fetch debug sessions failed",i),d("Failed to fetch sessions; ensure admin JWT is set in localStorage"),h([]),m([])}finally{r(!1)}};a.useEffect(()=>{p()},[]);const k=()=>{try{if(!u){o("Please paste a token first");return}localStorage.setItem("admin_dashboard_token",u),o("Token saved. Refreshing..."),d(null),setTimeout(()=>{p(),o("")},300)}catch(s){console.error("save token failed",s),o("Failed to save token")}},y=Date.now(),N=n.filter(s=>{if(!s)return!1;if(b){if(!s.last_ping_at)return!1;const i=new Date(s.last_ping_at).getTime();if(isNaN(i)||y-i>6e4)return!1}if(!l)return!0;const t=l.toLowerCase();return(s.session_id||"").toLowerCase().includes(t)||(s.path||"").toLowerCase().includes(t)||(s.user_id||"").toLowerCase().includes(t)});return e.jsxs(C,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{name:"Activity",size:20,className:"text-accent"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Active Sessions"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Live sessions and recent page views"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:l,onChange:s=>S(s.target.value),placeholder:"Search session / path / user",className:"px-3 py-2 border border-border rounded"}),e.jsxs("label",{className:"ml-2 flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:b,onChange:s=>_(s.target.checked)})," Live only"]}),e.jsx("button",{onClick:p,className:"px-3 py-2 bg-accent text-white rounded",children:"Refresh"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("input",{value:u,onChange:s=>v(s.target.value),placeholder:"Paste admin JWT here",className:"px-3 py-2 border border-border rounded w-80"}),e.jsx("button",{onClick:k,className:"px-3 py-2 bg-primary text-white rounded",children:"Set token"}),g&&e.jsx("div",{className:"text-sm text-muted-foreground",children:g})]})]}),j&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded",children:j}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-card p-4 rounded border border-border",children:[e.jsxs("h3",{className:"font-semibold mb-2",children:["Sessions (",N.length,")"]}),e.jsx("div",{className:"overflow-auto max-h-96",children:e.jsxs("table",{className:"w-full text-sm table-auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-2",children:"session"}),e.jsx("th",{className:"px-2",children:"user"}),e.jsx("th",{className:"px-2",children:"path"}),e.jsx("th",{className:"px-2",children:"last ping"}),e.jsx("th",{className:"px-2",children:"duration"})]})}),e.jsx("tbody",{children:N.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-2 truncate max-w-xs",children:s.session_id}),e.jsx("td",{className:"px-2",children:s.user_id||"—"}),e.jsx("td",{className:"px-2 truncate max-w-xs",children:s.path||"—"}),e.jsx("td",{className:"px-2",children:s.last_ping_at?new Date(s.last_ping_at).toLocaleString():"—"}),e.jsx("td",{className:"px-2",children:s.duration_seconds??"—"})]},s.session_id))})]})})]}),e.jsxs("div",{className:"bg-card p-4 rounded border border-border",children:[e.jsxs("h3",{className:"font-semibold mb-2",children:["Recent Page Views (",f.length,")"]}),e.jsx("div",{className:"overflow-auto max-h-96",children:e.jsxs("table",{className:"w-full text-sm table-auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-2",children:"id"}),e.jsx("th",{className:"px-2",children:"session"}),e.jsx("th",{className:"px-2",children:"path"}),e.jsx("th",{className:"px-2",children:"time"})]})}),e.jsx("tbody",{children:f.filter(s=>{if(!l)return!0;const t=l.toLowerCase();return(s.id||"").toLowerCase().includes(t)||(s.path||"").toLowerCase().includes(t)||(s.session_id||"").toLowerCase().includes(t)}).map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-2 truncate max-w-xs",children:s.id}),e.jsx("td",{className:"px-2 truncate max-w-xs",children:s.session_id||"—"}),e.jsx("td",{className:"px-2",children:s.path||"—"}),e.jsx("td",{className:"px-2",children:s.created_at?new Date(s.created_at).toLocaleString():"—"})]},s.id))})]})})]})]})]})}export{D as default};
